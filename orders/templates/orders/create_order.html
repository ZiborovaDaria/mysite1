{% extends "base.html" %}
{% load static %}
{% load carts_tags %}

{% block css %}
<link rel="stylesheet" href="{% static "deps/css/my_footer_css.css" %}">
<style>
.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c2c7;
    color: #842029;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
}

.alert-success {
    background-color: #d1e7dd;
    border-color: #badbcc;
    color: #0f5132;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
}
</style>
{% endblock css %}

{% block content %}
{% user_carts request as carts %}
<!-- Детали заказа -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-15">
            <!-- Добавьте этот блок для отображения сообщений -->
                {% if messages %}
                <div class="mb-4">
                    {% for message in messages %}
                    <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h3 class="mb-0">Детали заказа</h3>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" 
                                        data-bs-target="#personal" type="button" role="tab" 
                                        aria-controls="personal" aria-selected="true">
                                    Персональные данные
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="delivery-tab" data-bs-toggle="tab" 
                                        data-bs-target="#delivery" type="button" role="tab" 
                                        aria-controls="delivery" aria-selected="false">
                                    Доставка и оплата
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" 
                                        data-bs-target="#summary" type="button" role="tab" 
                                        aria-controls="summary" aria-selected="false">
                                    Итог
                                </button>
                            </li>
                        </ul>

                        <form action="{% url "orders:create_order" %}" method="post" id="order-form">
                            {% csrf_token %}
                            
                            <div class="tab-content" id="orderTabsContent">
                                <!-- Персональные данные -->
                                <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="id_first_name" class="form-label">Имя*</label>
                                            <input type="text" class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                                                id="id_first_name" name="first_name"
                                                value="{% if form.first_name.value %}{{ form.first_name.value }}{% elif user.first_name %}{{ user.first_name }}{% endif %}" 
                                                required>
                                            {% if form.first_name.errors %}
                                            <div class="invalid-feedback">
                                                {{ form.first_name.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="id_last_name" class="form-label">Фамилия*</label>
                                            <input type="text" class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                                                id="id_last_name" name="last_name"
                                                value="{% if form.last_name.value %}{{ form.last_name.value }}{% elif user.last_name %}{{ user.last_name }}{% endif %}" 
                                                required>
                                            {% if form.last_name.errors %}
                                            <div class="invalid-feedback">
                                                {{ form.last_name.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_phone_number" class="form-label">Номер телефона*</label>
                                        <input type="tel" class="form-control {% if form.phone_number.errors %}is-invalid{% endif %}" 
                                            id="id_phone_number" name="phone_number"
                                            placeholder="В формате: 79991234567"
                                            value="{{ form.phone_number.value|default:'' }}" required>
                                        {% if form.phone_number.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.phone_number.errors.0 }}
                                        </div>
                                        {% endif %}
                                        <small class="text-muted">Пример: 79991234567 (11 цифр без пробелов и разделителей)</small>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-dark next-tab" data-target="delivery">
                                            Далее <i class="bi bi-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Доставка и оплата -->
                                <div class="tab-pane fade" id="delivery" role="tabpanel" aria-labelledby="delivery-tab">
                                    <div class="mb-4">
                                        <h5 class="mb-3 border-bottom pb-2">Способ получения</h5>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="requires_delivery" 
                                                    id="delivery-yes" value="1" {% if form.requires_delivery.value == "1" or not form.requires_delivery.value %}checked{% endif %}>
                                                <label class="form-check-label" for="delivery-yes">
                                                    Доставка курьером
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="requires_delivery" 
                                                    id="delivery-no" value="0" {% if form.requires_delivery.value == "0" %}checked{% endif %}>
                                                <label class="form-check-label" for="delivery-no">
                                                    Самовывоз из магазина
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-3" id="delivery-address-group" {% if form.requires_delivery.value == "0" %}style="display: none;"{% endif %}>
                                            <label for="id_delivery_address" class="form-label">Адрес доставки*</label>
                                            <textarea class="form-control {% if form.delivery_address.errors %}is-invalid{% endif %}" 
                                                    id="id_delivery_address" name="delivery_address" rows="3">{{ form.delivery_address.value|default:'' }}</textarea>
                                            {% if form.delivery_address.errors %}
                                            <div class="invalid-feedback">
                                                {{ form.delivery_address.errors.0 }}
                                            </div>
                                            {% endif %}
                                            <small class="text-muted">Укажите город, улицу, дом и квартиру</small>
                                        </div>
                                        <div class="mb-3" id="pickup-locations" {% if form.requires_delivery.value != "0" %}style="display: none;"{% endif %}>
                                            <label class="form-label">Выберите магазин для самовывоза:</label>
                                            <div class="stores-map mb-3" style="height: 300px; background: #f5f5f5; border-radius: 8px;">
                                                <!-- Карта магазинов -->
                                                <div id="map" style="width: 100%; height: 100%; border-radius: 8px;"></div>
                                            </div>
                                            <div class="stores-list">
                                                {% for store in stores %}
                                                <div class="card mb-2 store-card {% if store.is_main %}border-primary{% endif %}" 
                                                    data-store-id="{{ store.id }}"
                                                    data-lat="{{ store.latitude }}" 
                                                    data-lng="{{ store.longitude }}"
                                                    onclick="selectStore(this)">
                                                    <div class="card-body">
                                                        <h5 class="card-title">{{ store.get_city_display }}</h5>
                                                        <p class="card-text mb-1">{{ store.address }}</p>
                                                        <p class="card-text mb-1"><small>Телефон: {{ store.phone }}</small></p>
                                                        <p class="card-text"><small>Часы работы: {{ store.opening_hours }}</small></p>
                                                        <a href="{{ store.get_map_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-map"></i> Открыть карту
                                                        </a>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <input type="hidden" id="id_pickup_store" name="pickup_store" value="">
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <h5 class="mb-3 border-bottom pb-2">Способ оплаты</h5>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_on_get" 
                                                    id="payment-card" value="0" {% if form.payment_on_get.value == "0" or not form.payment_on_get.value %}checked{% endif %}>
                                                <label class="form-check-label" for="payment-card">
                                                    Оплата картой онлайн
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_on_get" 
                                                    id="payment-cash" value="1" {% if form.payment_on_get.value == "1" %}checked{% endif %}>
                                                <label class="form-check-label" for="payment-cash">
                                                    Оплата при получении (наличными или картой)
                                                </label>
                                            </div>
                                            {% if form.payment_on_get.errors %}
                                            <div class="alert alert-danger mt-2">
                                                {{ form.payment_on_get.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-outline-secondary prev-tab" data-target="personal">
                                            <i class="bi bi-arrow-left"></i> Назад
                                        </button>
                                        <button type="button" class="btn btn-dark next-tab" data-target="summary">
                                            Далее <i class="bi bi-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Итоговая информация -->
                                <div class="tab-pane fade" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                                    <div class="order-summary">
                                        <h5 class="mb-3 border-bottom pb-2">Ваш заказ</h5>
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Товар</th>
                                                        <th class="text-end">Количество</th>
                                                        <th class="text-end">Сумма</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for cart in carts %}
                                                    <tr data-available="{{ cart.product.quantity }}">
                                                        <td>{{ cart.product.name }}</td>
                                                        <td class="text-end">{{ cart.quantity }} шт.</td>
                                                        <td class="text-end">{{ cart.products_price }} ₽</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <th colspan="2">Итого:</th>
                                                        <th class="text-end">{{ carts.total_price }} ₽</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>

                                        <div class="delivery-summary mt-4">
                                            <h5 class="mb-3 border-bottom pb-2">Данные доставки</h5>
                                            <div id="delivery-summary-content">
                                                <!-- Здесь будет динамически подгружаться информация о доставке -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-outline-secondary prev-tab" data-target="delivery">
                                            <i class="bi bi-arrow-left"></i> Назад
                                        </button>
                                        <button type="submit" class="btn btn-success" id="submit-order">
                                            <i class="bi bi-check-circle"></i> Подтвердить заказ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://api-maps.yandex.ru/2.1/?apikey=48b8c233-8399-462a-a05d-4ff9a1bfa51a&lang=ru_RU" type="text/javascript"></script>
<script>
// Глобальные переменные для карты и меток
let map;
let placemarks = [];
let userCity = '{{ user.city|default:"Москва" }}'; // Получаем город пользователя из контекста

// Инициализация карты магазинов
function initMap() {
    if (typeof ymaps !== 'undefined') {
        ymaps.ready(function() {
            // Определяем центр карты по городу пользователя
            let defaultCenter, defaultZoom;
            switch(userCity) {
                case 'Москва':
                    defaultCenter = [55.7558, 37.6176];
                    defaultZoom = 11;
                    break;
                case 'Санкт-Петербург':
                    defaultCenter = [59.9343, 30.3351];
                    defaultZoom = 11;
                    break;
                case 'Екатеринбург':
                    defaultCenter = [56.8389, 60.6057];
                    defaultZoom = 12;
                    break;
                case 'Казань':
                    defaultCenter = [55.7963, 49.1088];
                    defaultZoom = 12;
                    break;
                case 'Нижний Новгород':
                    defaultCenter = [56.3269, 44.0059];
                    defaultZoom = 12;
                    break;
                default:
                    defaultCenter = [55.7558, 37.6176]; // Москва по умолчанию
                    defaultZoom = 10;
            }

            // Создаем карту
            map = new ymaps.Map("map", {
                center: defaultCenter,
                zoom: defaultZoom,
                controls: ['zoomControl']
            });

            // Добавляем метки магазинов из Django-шаблона
            const storeCards = document.querySelectorAll('.store-card');
            storeCards.forEach(card => {
                const lat = parseFloat(card.dataset.lat);
                const lng = parseFloat(card.dataset.lng);
                const storeId = card.dataset.storeId;
                const title = card.querySelector('.card-title').textContent;
                const address = card.querySelector('.card-text').textContent;
                
                const placemark = new ymaps.Placemark([lat, lng], {
                    hintContent: title,
                    balloonContent: address
                }, {
                    preset: 'islands#blueShoppingIcon',
                    storeId: storeId // Сохраняем ID магазина в метке
                });
                
                // Обработчик клика по метке
                placemark.events.add('click', function() {
                    const card = document.querySelector(`.store-card[data-store-id="${storeId}"]`);
                    if (card) {
                        selectStore(card);
                        scrollToStoreCard(card);
                    }
                });
                
                map.geoObjects.add(placemark);
                placemarks.push(placemark);
                
                // Если это главный магазин, центрируем на нем
                if (card.classList.contains('border-primary')) {
                    map.setCenter([lat, lng], 15);
                    document.getElementById('id_pickup_store').value = storeId;
                }
            });

            // Автоматическое подстраивание границ карты
            if (storeCards.length > 0) {
                map.setBounds(map.geoObjects.getBounds(), {
                    checkZoomRange: true
                });
            }
        });
    }
}

// Прокрутка к выбранной карточке магазина
function scrollToStoreCard(cardElement) {
    cardElement.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
    });
}

// Выбор магазина для самовывоза
function selectStore(element) {
    // Снимаем выделение со всех карточек
    document.querySelectorAll('.store-card').forEach(card => {
        card.classList.remove('border-primary', 'bg-light');
    });
    
    // Выделяем выбранную карточку
    element.classList.add('border-primary', 'bg-light');
    const storeId = element.dataset.storeId;
    document.getElementById('id_pickup_store').value = storeId;
    
    // Центрируем карту на выбранном магазине
    if (map && storeId) {
        const placemark = placemarks.find(p => p.options.get('storeId') == storeId);
        if (placemark) {
            map.setCenter(placemark.geometry.getCoordinates(), 15);
            
            // Открываем балун с информацией
            placemark.balloon.open();
        }
    }
    
    updateDeliverySummary();
}

// Обновление информации о доставке в итоговой вкладке
function updateDeliverySummary() {
    const deliveryMethod = document.querySelector('input[name="requires_delivery"]:checked').value;
    let summaryHtml = '';
    
    if (deliveryMethod === "1") {
        const address = document.getElementById('id_delivery_address').value;
        summaryHtml = `
            <p><strong>Способ получения:</strong> Доставка курьером</p>
            <p><strong>Адрес доставки:</strong> ${address || 'Не указан'}</p>
        `;
    } else {
        const selectedStore = document.querySelector('.store-card.border-primary');
        if (selectedStore) {
            const storeTitle = selectedStore.querySelector('.card-title').textContent;
            const storeAddress = selectedStore.querySelector('.card-text').textContent;
            const storeHours = selectedStore.querySelectorAll('.card-text')[1].textContent;
            
            summaryHtml = `
                <p><strong>Способ получения:</strong> Самовывоз</p>
                <p><strong>Магазин:</strong> ${storeTitle}</p>
                <p><strong>Адрес:</strong> ${storeAddress}</p>
                <p><strong>Часы работы:</strong> ${storeHours}</p>
            `;
        } else {
            summaryHtml = '<p><strong>Способ получения:</strong> Самовывоз (магазин не выбран)</p>';
        }
    }
    
    const paymentMethod = document.querySelector('input[name="payment_on_get"]:checked').value;
    const paymentText = paymentMethod === "1" ? 
        'Оплата при получении (наличными или картой)' : 'Оплата картой онлайн';
    
    summaryHtml += `<p><strong>Способ оплаты:</strong> ${paymentText}</p>`;
    document.getElementById('delivery-summary-content').innerHTML = summaryHtml;
}

// Обработчик события DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация карты
    initMap();
    
    // Переключение между вкладками
    document.querySelectorAll('.next-tab').forEach(button => {
        button.addEventListener('click', function() {
            const target = this.dataset.target;
            const tab = document.querySelector(`#${target}-tab`);
            if (tab) {
                new bootstrap.Tab(tab).show();
            }
        });
    });
    
    document.querySelectorAll('.prev-tab').forEach(button => {
        button.addEventListener('click', function() {
            const target = this.dataset.target;
            const tab = document.querySelector(`#${target}-tab`);
            if (tab) {
                new bootstrap.Tab(tab).show();
            }
        });
    });
    
    // Показывать/скрывать поле адреса доставки и карту магазинов
    document.querySelectorAll('input[name="requires_delivery"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const deliveryAddressGroup = document.getElementById('delivery-address-group');
            const pickupLocations = document.getElementById('pickup-locations');
            const deliveryAddress = document.getElementById('id_delivery_address');
            
            if (this.value === "1") {
                deliveryAddressGroup.style.display = 'block';
                pickupLocations.style.display = 'none';
                deliveryAddress.required = true;
            } else {
                deliveryAddressGroup.style.display = 'none';
                pickupLocations.style.display = 'block';
                deliveryAddress.required = false;
                
                // Если карта еще не инициализирована, инициализируем ее
                if (typeof map === 'undefined') {
                    initMap();
                }
            }
            
            updateDeliverySummary();
        });
    });
    
    // Форматирование номера телефона
    const phoneInput = document.getElementById('id_phone_number');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });
    }
    
    // Обновление информации при изменении способа оплаты
    document.querySelectorAll('input[name="payment_on_get"]').forEach(radio => {
        radio.addEventListener('change', updateDeliverySummary);
    });
    
    // Обновление информации при изменении адреса доставки
    const addressInput = document.getElementById('id_delivery_address');
    if (addressInput) {
        addressInput.addEventListener('input', updateDeliverySummary);
    }
    
    // Валидация формы перед отправкой
    const orderForm = document.getElementById('order-form');
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            // Проверка номера телефона
            const phone = document.getElementById('id_phone_number').value;
            if (phone.length !== 11) {
                e.preventDefault();
                const phoneInput = document.getElementById('id_phone_number');
                phoneInput.classList.add('is-invalid');
                const feedback = phoneInput.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = 'Номер телефона должен содержать 11 цифр';
                }
                
                // Переход на вкладку с ошибкой
                const personalTab = document.querySelector('#personal-tab');
                if (personalTab) {
                    new bootstrap.Tab(personalTab).show();
                }
                return false;
            }
            
            // Проверка выбора магазина для самовывоза
            const requiresDelivery = document.querySelector('input[name="requires_delivery"]:checked').value;
            if (requiresDelivery === "0" && !document.querySelector('.store-card.border-primary')) {
                e.preventDefault();
                alert('Пожалуйста, выберите магазин для самовывоза');
                
                // Переход на вкладку доставки
                const deliveryTab = document.querySelector('#delivery-tab');
                if (deliveryTab) {
                    new bootstrap.Tab(deliveryTab).show();
                }
                return false;
            }
            
            return true;
        });
    }
    
    // Инициализация при загрузке
    updateDeliverySummary();
    
    // Выбираем главный магазин по умолчанию
    const mainStore = document.querySelector('.store-card.border-primary');
    if (mainStore) {
        selectStore(mainStore);
    }
    
    // Обработчик клика по карточке магазина
    document.querySelectorAll('.store-card').forEach(card => {
        card.addEventListener('click', function() {
            selectStore(this);
        });
    });
});


document.getElementById('order-form').addEventListener('submit', function(e) {
    // Проверка наличия товаров
    const cartItems = document.querySelectorAll('tbody tr');
    let errorMessage = '';
    
    cartItems.forEach(item => {
        const productName = item.querySelector('td:first-child').textContent.trim();
        const quantity = parseInt(item.querySelector('td:nth-child(2)').textContent);
        const available = parseInt(item.dataset.available || 9999); // Можно добавить data-available атрибут
        
        if (quantity > available) {
            errorMessage += `Недостаточно товара "${productName}". В наличии: ${available}\n`;
        }
    });
    
    if (errorMessage) {
        e.preventDefault();
        //alert('Проблемы с заказом:\n' + errorMessage);
        // Можно также отобразить ошибки более красиво
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.innerHTML = errorMessage.replace(/\n/g, '<br>');
        document.querySelector('.order-summary').prepend(errorDiv);
    }
});
</script>
{% endblock content %}